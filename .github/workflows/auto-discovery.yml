# Autonomous MCP Tool Discovery
# Runs on a schedule to automatically discover new MCP tools
# and optionally create PRs with the findings

name: ğŸ” Auto Discovery

on:
  # Scheduled runs
  schedule:
    # Hourly discovery (light scan)
    - cron: '0 */6 * * *'    # Every 6 hours
    # Daily deep scan
    - cron: '0 2 * * *'      # Daily at 2 AM UTC
    # Weekly comprehensive scan
    - cron: '0 3 * * 0'      # Weekly on Sunday at 3 AM UTC

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      sources:
        description: 'Sources to scan (comma-separated)'
        required: false
        default: 'github,npm'
        type: choice
        options:
          - 'github'
          - 'npm'
          - 'github,npm'
      limit:
        description: 'Maximum tools to discover'
        required: false
        default: '10'
      dry_run:
        description: 'Dry run (skip AI analysis)'
        type: boolean
        default: false
      create_pr:
        description: 'Create PR with results'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-discovery-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  discover:
    name: ğŸ” Discover Tools
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      tools_count: ${{ steps.discovery.outputs.tools_count }}
      has_results: ${{ steps.discovery.outputs.has_results }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Build
        run: pnpm build

      - name: ğŸ—‚ï¸ Create data directory
        run: mkdir -p data

      - name: ğŸ” Run Discovery
        id: discovery
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Determine scan type based on schedule or input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SOURCES="${{ github.event.inputs.sources }}"
            LIMIT="${{ github.event.inputs.limit }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
          elif [ "${{ github.event.schedule }}" == "0 3 * * 0" ]; then
            # Weekly comprehensive scan
            SOURCES="github,npm"
            LIMIT="50"
            DRY_RUN="false"
            echo "ğŸ“… Running weekly comprehensive scan"
          elif [ "${{ github.event.schedule }}" == "0 2 * * *" ]; then
            # Daily deep scan
            SOURCES="github,npm"
            LIMIT="20"
            DRY_RUN="false"
            echo "ğŸ“… Running daily deep scan"
          else
            # Hourly light scan
            SOURCES="github"
            LIMIT="5"
            DRY_RUN="false"
            echo "ğŸ“… Running periodic light scan"
          fi
          
          # Build command
          CMD="node dist/cli.js discover --sources=${SOURCES} --limit=${LIMIT}"
          
          if [ "$DRY_RUN" == "true" ]; then
            CMD="$CMD --dry-run"
          fi
          
          echo "ğŸš€ Running: $CMD"
          
          # Run discovery and capture output
          $CMD 2>&1 | tee discovery.log || true
          
          # Create results file with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          FILENAME="data/discovery-${TIMESTAMP//:/-}.json"
          
          # Parse results from log (tools analyzed)
          TOOLS_COUNT=$(grep -o "Analyzed [0-9]* tools" discovery.log | grep -o "[0-9]*" || echo "0")
          
          if [ -z "$TOOLS_COUNT" ] || [ "$TOOLS_COUNT" == "0" ]; then
            TOOLS_COUNT="0"
            HAS_RESULTS="false"
          else
            HAS_RESULTS="true"
          fi
          
          echo "tools_count=$TOOLS_COUNT" >> $GITHUB_OUTPUT
          echo "has_results=$HAS_RESULTS" >> $GITHUB_OUTPUT
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "âœ… Discovery complete: found $TOOLS_COUNT tools"

      - name: ğŸ“¤ Upload Discovery Log
        uses: actions/upload-artifact@v4
        with:
          name: discovery-log-${{ github.run_number }}
          path: discovery.log
          retention-days: 30

      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸ” MCP Tool Discovery Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tools Discovered | ${{ steps.discovery.outputs.tools_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f discovery.log ]; then
            echo "### ğŸ“‹ Discovery Log (Last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 discovery.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # Create PR with discovered tools (optional)
  create-pr:
    name: ğŸ“ Create PR
    runs-on: ubuntu-latest
    needs: discover
    if: |
      needs.discover.outputs.has_results == 'true' && 
      (github.event_name != 'workflow_dispatch' || github.event.inputs.create_pr == 'true')
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ Build
        run: pnpm build

      - name: ğŸ—‚ï¸ Create data directory
        run: mkdir -p data

      - name: ğŸ” Re-run Discovery for PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Re-run to generate fresh results for the PR
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          
          node dist/cli.js discover \
            --sources=github,npm \
            --limit=10 \
            2>&1 | tee "data/discovery-${TIMESTAMP}.log"

      - name: ğŸ“ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ¤– Auto-discovery: Found ${{ needs.discover.outputs.tools_count }} MCP tools"
          title: "ğŸ¤– Tool Discovery: ${{ needs.discover.outputs.tools_count }} new tools discovered"
          body: |
            ## ğŸ” Automated Tool Discovery Report
            
            **Run ID:** `${{ github.run_id }}`
            **Run Number:** #${{ github.run_number }}
            **Date:** ${{ github.event.repository.updated_at }}
            **Trigger:** ${{ github.event_name }}
            
            ### ğŸ“Š Statistics
            
            | Metric | Count |
            |--------|-------|
            | Tools Discovered | ${{ needs.discover.outputs.tools_count }} |
            
            ### ğŸ”— Links
            
            - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            _This PR was automatically generated by the Lyra Tool Discovery Agent._
          branch: auto-discovery/run-${{ github.run_number }}
          delete-branch: true
          labels: |
            auto-discovery
            automated-pr

  # Notify on failures or significant discoveries
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: discover
    if: failure()
    
    steps:
      - name: âš ï¸ Notify on Failure
        run: |
          echo "::error::Discovery workflow failed!"
          echo "Check the workflow run for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
