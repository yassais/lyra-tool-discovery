# MCP Tool Discovery Agent
# Runs hourly to discover new MCP tools
#
# Discovers tools from:
# - GitHub repositories
# - npm packages  
# - Awesome MCP lists
# - Hacker News, Reddit
#
# Creates PRs with discovered tools in this repo

name: ðŸ” Discover MCP Tools

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      sources:
        description: 'Sources (github,npm,awesome-list)'
        required: false
        default: 'github,npm,awesome-list'
      dry_run:
        description: 'Dry run (no PRs)'
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'

jobs:
  discover:
    name: Discover Tools
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm install

      - name: ðŸ”§ Build
        run: npm run build

      - name: ðŸ” Run discovery
        id: discovery
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          FLAGS=""
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              FLAGS="$FLAGS --dry-run"
            fi
            if [ -n "${{ github.event.inputs.sources }}" ]; then
              FLAGS="$FLAGS --sources=${{ github.event.inputs.sources }}"
            fi
          fi
          
          node dist/cli.js discover $FLAGS --output=data/discovered-tools.json 2>&1 | tee discovery.log
          
          # Count results
          TOOLS=$(grep -o '"totalDiscovered":[0-9]*' discovery.log | grep -o '[0-9]*' || echo "0")
          echo "tools_found=$TOOLS" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload results
        uses: actions/upload-artifact@v4
        with:
          name: discovery-results
          path: |
            discovery.log
            data/discovered-tools.json
          retention-days: 30

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ” Discovery Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tools Found:** ${{ steps.discovery.outputs.tools_found }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Run: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> $GITHUB_STEP_SUMMARY

  # Weekly deep scan
  weekly:
    name: Weekly Deep Scan
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 0'
    timeout-minutes: 60
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - run: npm install && npm run build
      
      - name: Deep scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node dist/cli.js discover --sources=github,npm,awesome-list --output=data/discovered-tools.json
